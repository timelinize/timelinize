name: Release

on: [workflow_dispatch]

jobs:
  Release:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest, macos-13]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Go
        uses: actions/setup-go@v5
        with:
          go-version: stable

      # TODO: The Windows Server 2022 runner apparently comes with msys2 installed
      # but I haven't looked into using it. We'd have to install the packages using
      # its shell, but I'm not sure how to do that.
      - name: Install MSYS2 (Windows)
        if: matrix.os == 'windows-latest'
        uses: msys2/setup-msys2@v2
        with:
          # TODO: Enable this for more current packages, I guess? But it takes longer.
          # update: true
          install: >-
             base-devel
             mingw-w64-x86_64-toolchain
             mingw-w64-x86_64-libvips

      - name: Install libraries (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libvips-dev

      - name: Install libraries (macOS)
        if: ${{ matrix.os == 'macos-latest' || matrix.os == 'macos-13' }}
        run: brew install vips

      # It is crucial to use our gcc compiler instead of the preinstalled gcc,
      # which has an MSYS2 path at c:\msys64. The MSYS2 we installed is at d:\a.
      # (Setting `CC` env var is not enough! You MUST *prepend* the PATH env var!)
      - name: Update PATH (Windows)
        if: matrix.os == 'windows-latest'
        shell: bash
        run: echo "D:\a\_temp\msys64\mingw64\bin" >> $GITHUB_PATH

      - name: Compile application
        env:
          CGO_ENABLED: 1
        run: |
          env
          go env
          echo "Building..."
          go build
          echo "Success."

      # We have to make our own tarballs for GitHub Actions to preserve executable bit when uploading >:(
      # This causes them to be downloaded as .zip containing another archive but oh well.

      - name: Compress build (macOS arm64)
        if: matrix.os == 'macos-latest'
        run: tar -czvf timelinize_${{ github.ref_name }}_mac_arm64.tar.gz timelinize

      - name: Compress build (macOS amd64)
        if: matrix.os == 'macos-13'
        run: tar -czvf timelinize_${{ github.ref_name }}_mac_amd64.tar.gz timelinize

      - name: Compress build (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: tar -czvf timelinize_${{ github.ref_name }}_linux_amd64.tar.gz timelinize

      - name: Compress build (Windows)
        if: matrix.os == 'windows-latest'
        run: 7z a timelinize_${{ github.ref_name }}_windows_amd64.zip timelinize.exe -r

      # - name: Release
      #   uses: softprops/action-gh-release@v2
      #   # if: startsWith(github.ref, 'refs/tags/')
      #   with:
      #     files: timelinize-alpha-*
    
      - name: Publish release
        run: |
          gh release create --generate-notes --target ${{ github.sha }} "${{ github.ref_name }}" "timelinize_${{ github.ref_name }}_*" \
          || gh release upload "${{ github.ref_name }}" "timelinize_${{ github.ref_name }}_*"
        env:
          GH_TOKEN: ${{ github.token }}

      # - name: Upload artifact (macOS)
      #   if: matrix.os == 'macos-latest'
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: timelinize-alpha-macos.tar.gz
      #     path: "*.tar.gz"
      
      # - name: Upload artifact (Linux)
      #   if: matrix.os == 'ubuntu-latest'
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: timelinize-alpha-linux-amd64.tar.gz
      #     path: "*.tar.gz"

      # - name: Upload artifact (Windows)
      #   if: matrix.os == 'windows-latest'
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: timelinize-alpha-windows.zip
      #     path: "*.zip"
